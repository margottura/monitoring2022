#set the working directory
setwd("C:/Documenti/Laurea magistrale/Tirocinio Duccio")

#upload all the packages
library(raster)
library(sp)
library(readr)
library(terra)
library(rgdal)
library(sf)
library(ecospat)
library(rgbif)
library(maptools)
library(devtools)
library(ade4)
library(ape)
library(biomod2)
library(virtualspecies)
library(viridis)
library(geodata)
library(corrplot)
library(ggcorrplot)
library(factoextra)
library(FactoMineR)
library(ggplot2)
library(tidyverse)

#load the cvs file with mangroves data
m_occ <- read.csv("m_occ.csv", sep="\t")
m_occ

#let's keep only the data for lat, long and year of observation
m_subset <- m_occ[, c("decimalLatitude", "decimalLongitude", "year")]
m_subset

#import shapefile from qgis using the terra package
m_shp <- vect("C:/Documenti/Laurea magistrale/Tirocinio Duccio/mangroves_shapefile.shp")
plot(m_shp)

#download data from worldclim
wclim <- geodata::worldclim_global(var="bio", res=10, versione="2.1", path = "C:/Documenti/Laurea magistrale/Tirocinio Duccio")
wclim

#Brisbane wordlclim data
wclim_aus <- worldclim_country("AUS", var="bio", res=10, versione="2.1", path="C:/Documenti/Laurea magistrale/Tirocinio Duccio")
wclim_aus
names(wclim_aus)<- c("Annual Mean Temperature", "Mean Diurnal Range", "Isothermality", "Temperature Seasonality", "Max Temperature of Warmest Month", "Min Temperature of Coldest Month", "Temperature Annual Range", "Mean Temperature of Wettest Quarter", "Mean Temperature of Driest Quarter", "Mean Temperature of Warmest Quarter", "Mean Temperature of Coldest Quarter", "Annual Precipitation", "Precipitation of Wettest Month", "Precipitation of Driest Month", "Precipitation Seasonality", "Precipitation of Wettest Quarter", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter", "Precipitation of Coldest Quarter")

#crop for Brisbane area (lat min 153, lat max 153.5, lon min -27.5, lon max -27.1)
bne_ext <- c(153, 153.5, -27.5, -27.1)
ext <- extent(bne_ext[1], bne_ext[2], bne_ext[3], bne_ext[4])

wclim_bne <- crop(wclim_aus, ext)
wclim_bne
plot(wclim_bne)

#select only some variables (which ones?)
subset_wclim_bne <- wclim_bne[[c(1,5,12,15,17,18)]]
subset_wclim_bne
plot(subset_wclim_bne)

#create a stack of raster with bne wclim data
bne_stack <- stack(subset_wclim_bne)
bne_stack

#plot the data using viridis
plot(bne_stack[[1]], col=viridis(500, alpha =1, begin=0, end=1, direction=1))
points(m_shp, pch=16, col= 0, cex=1)

 plot(bne_stack, col=viridis(500, alpha =1, begin=0, end=1, direction=1))

#######################################
#statistical analysis
#1. correlation matrix (shows which variables are strongly associated)
# Subsample 10% of pixels and calculate pairwise correlations

r1 <- bne_stack$Annual.Mean.Temperature
cor <- cor(sampleRandom(bne_stack, size=ncell(r1)*0.30), method="pearson")

#plot the correlation matrix
df <- corrplot(cor, method="number", col=viridis(30, alpha=1, begin=0, end=1, direction=1), type="lower", tl.pos='ld')
)

#2. PCA (principal component analysis) (seguito dal tutorial sulla PCA)
#normalize the data
#make a dataframe of bne wclim data
bne_df <- as.data.frame(subset_wclim_bne)
bne_num <- bne_df[,]
head(bne_norm)
bne_norm <- scale(bne_num)
head(bne_norm)

#correlation matrix with normalized data
cor_norm <- cor(bne_norm)
ggcorrplot(bne_norm)

#apply PCA
bne_pca <- princomp(cor_norm)
summary(bne_pca)
bne_pca$loadings[, 1:2]

#data visualization
# scree plot
fviz_eig(bne_pca, addlabels=TRUE)

#biplot of the attributes
fviz_pca_var(bne_pca, col.var="black")

#contribution of each variable
fviz_cos2(bne_pca, choice="var", axes= 1:2)

#biplot combined with cos2
fviz_pca_var(bne_pca, col.var = "cos2",
             gradient.cols = c("black", "blue", "red"),
             repel = TRUE)

###########################################
#random species generation
#suitability map generation
random.sp <- generateRandomSp(raster.stack=bne_stack, convert.to.PA=FALSE, species.type="multiplicative",
                              approach="random", relations="gaussian", realistic.sp=TRUE, plot=FALSE)

plot(random.sp$suitab.raster, col = viridis(500, alpha=1, begin=0, end=1, direction=1))

#let's visualize the variables contribution
plotResponse(random.sp)

#presence/absence
bne_pres <- convertToPA(random.sp, beta="random", alpha= -0.5, plot=FALSE, species.prevalence= 0.1)

#plot the realized niche
plot(bne_pres$pa.raster)

#occurrences
bne_pres$pa.raster %>% raster()
pres_points <- sampleOccurrences(bne_pres, n=100, type= "presence only", sample.prevalence = 0.9, error.probability=0, 
                                 detection.probability=1, correct.by.suitability=TRUE, plot=FALSE)
plot(bne_stack[[1]], col=viridis(500, alpha=1, begin=0, end=1, direction=1))
points(pres_points$sample.points, col="black", pch=19)

##################
#niche modelling (ecospat tutorial)
#extract wclim variables for occurrences points
coordinates(m_subset) <- c("decimalLongitude", "decimalLatitude")
proj4string(m_subset) <- CRS("+proj=longlat +datum=WGS84")
occ_wclim <- extract(bne_stack, m_subset)

#add them into one dataset
merged_data <- cbind(m_subset, occ_wclim)
merged_data

#plot the data
data(wrld_simpl)
par(mar = c(1, 0, 0, 0))
plot(wrld_simpl, border = "gray80")
points(merged_data, pch=16, col=2, cex=0.3)

#make a dataframe
merged_df <- as.data.frame(merged_data)

for (col in 1:ncol(merged_df)) {if (grepl("temp", colnames(merged_df)[col])) {
  merged_df[, col] <- merged_df[, col] / 10}}

merged_df <- na.omit(merged_df)    
merged_df
names(merged_df)

#calculate basic statistics
bne_stats <- apply(merged_df, 2, function(x) c(min=min(x), median(x), mean=mean(x), max=max(x), sd=sd(x)))
bne_stats

#calculate spatial autocorrelation 
ecospat.mantel.correlogram(dfvar=merged_df[c(1:9)], colxy=8:9, n=100, colvar=1:7, max=10, nclass=10, nperm=100)

#niche quantification
subset_wclim_bne <- na.omit(subset_wclim_bne)
pca.wclim <- dudi.pca(subset_wclim_bne, center=TRUE, scale=TRUE, scannf=FALSE, nf=2)
bne_scores <- pca.wclim$li

bne_scores_LS <- suprow(pca.wclim, merged_df[, 2:7])$li
bne_scores_Env <- suprow(pca.wclim, subset_wclim_bne)$li

#plot the niche
bne_grid <- ecospat.grid.clim.dyn(bne_scores, bne_scores_Env, bne_scores_LS)
ecospat.plot.niche.dyn(bne_grid, bne_grid, quant = 0.1, interest = 2, title = "Niche", name.axis1 = "PC1", name.axis2 = "PC2")

#plot the variable contributions
ecospat.plot.contrib(contrib=pca.wclim$co, eigen=pca.wclim$eig)


