setwd("C:/Documenti/Laurea magistrale/Tirocinio Duccio")

library(raster)
library(sp)
library(readr)
library(terra)
library(rgdal)
library(sf)
library(ecospat)
library(rgbif)
library(maptools)
library(devtools)
library(ade4)
library(ape)
library(biomod2)
library(virtualspecies)
library(viridis)
library(geodata)
library(corrplot)
library(ggcorrplot)
library(factoextra)
library(FactoMineR)

#let's load the csv file with the mangroves data
mangrovesdata <- read.csv("mangrovesdata.csv", sep = "\t")
mangrovesdata
#let's only keep the data for lat, long and year of observation
mangroves_subset <- mangrovesdata[, c("decimalLatitude", "decimalLongitude", "year")]
mangroves_subset

#now let's import the shapefile from qgis using the terra package

mangroves_shapefile <- vect("C:/Documenti/Laurea magistrale/Tirocinio Duccio/mangroves_shapefile.shp")

plot(mangroves_shapefile)

#ora trasformiamo i dati vettoriali in raster

#Now let's download the data from WorldClim
worldclim_data <- geodata::worldclim_global(var="bio", res=10, versione="2.1", path = "C:/Documenti/Laurea magistrale/Tirocinio Duccio")
worldclim_data

#let's change the names of the variables
names(worldclim_data) <- c("Annual Mean Temperature", "Mean Diurnal Range", "Isothermality", "Temperature Seasonality", "Max Temperature of Warmest Month", "Min Temperature of Coldest Month", "Temperature Annual Range", "Mean Temperature of Wettest Quarter", "Mean Temperature of Driest Quarter", "Mean Temperature of Warmest Quarter", "Mean Temperature of Coldest Quarter", "Annual Precipitation", "Precipitation of Wettest Month", "Precipitation of Driest Month", "Precipitation Seasonality", "Precipitation of Wettest Quarter", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter", "Precipitation of Coldest Quarter")
worldclim_data

#let's check if it worked
worldclim_data$`Annual Mean Temperature`

#Now let's crop the data for our area of interest (Brisbane)

data_australia <- worldclim_country("AUS", var="bio", res=10, versione="2.1", path="C:/Documenti/Laurea magistrale/Tirocinio Duccio")
data_australia
names(data_australia) <- c("Annual Mean Temperature", "Mean Diurnal Range", "Isothermality", "Temperature Seasonality", "Max Temperature of Warmest Month", "Min Temperature of Coldest Month", "Temperature Annual Range", "Mean Temperature of Wettest Quarter", "Mean Temperature of Driest Quarter", "Mean Temperature of Warmest Quarter", "Mean Temperature of Coldest Quarter", "Annual Precipitation", "Precipitation of Wettest Month", "Precipitation of Driest Month", "Precipitation Seasonality", "Precipitation of Wettest Quarter", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter", "Precipitation of Coldest Quarter")

#now let's crop our data to only have the Brisbane areas (lat min 153, lat max 153.5, lon min -27.5, lon max -27.1)
lat_min <- 153
lat_max <- 153.5
lon_min <- -27.5
lon_max <- -27.1

brisbane_ext <- c(153, 153.5, -27.5, -27.1)
ext <- extent(brisbane_ext[1], brisbane_ext[2], brisbane_ext[3], brisbane_ext[4])

data_brisbane <- crop(data_australia, ext)
names(data_brisbane) <- c("Annual Mean Temperature", "Mean Diurnal Range", "Isothermality", "Temperature Seasonality", "Max Temperature of Warmest Month", "Min Temperature of Coldest Month", "Temperature Annual Range", "Mean Temperature of Wettest Quarter", "Mean Temperature of Driest Quarter", "Mean Temperature of Warmest Quarter", "Mean Temperature of Coldest Quarter", "Annual Precipitation", "Precipitation of Wettest Month", "Precipitation of Driest Month", "Precipitation Seasonality", "Precipitation of Wettest Quarter", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter", "Precipitation of Coldest Quarter")
data_brisbane

plot(data_brisbane)

#let's select only the variables we need 
new_data_brisbane <- data_brisbane[[c(1, 5, 12, 15, 17, 18)]]
names(new_data_brisbane) <- c("Annual Mean Temperature", "Max Temperature of Warmest Month", "Annual Precipitation", "Precipitation Seasonality", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter")
new_data_brisbane
plot(new_data_brisbane)

#let's create a stack of raster with the brisbane worldclim data
mydata <- stack(new_data_brisbane)
mydata

#let's try for bio1 and bio2
plot(mydata[[1]], col=viridis(500, alpha =1, begin=0, end=1, direction=1))
plot(mydata[[2]], col=viridis(500, alpha =1, begin=0, end=1, direction=1))
plot(mydata, col=viridis(500, alpha =1, begin=0, end=1, direction=1))

#let's plot the point records using the maptools map
points(mangroves_shapefile, pch=16, col= 0, cex=1)


#now let's create a correlation matrix to see which variables are strongly associated with each other
# Subsample 10% of pixels and calculate pairwise correlations
r1 <-mydata$Annual.Mean.Temperature
cor <- cor(sampleRandom(mydata, size=ncell(r1)*0.30), method="pearson")

#now let's plot the correlation matrix
df <- corrplot(cor, method="number", col=magma(30, alpha=1, begin=0, end=1, direction=1), type="lower", tl.pos='ld')


##############################
#PCA
#let's make a PCA of the environmental data
#let's normalize the data
bne_wclim_dataframe
numerical_data <- bne_wclim_dataframe[,]
head(numerical_data)

data_normalized <- scale(numerical_data)
head(data_normalized)

#let's compute the correlation matrix
corr_matrix <- cor(data_normalized)
ggcorrplot(corr_matrix)

#let's apply PCA
data.pca <- princomp(corr_matrix)
summary(data.pca)
data.pca$loadings[, 1:2]

#let's visualize the data
#Scree plot
fviz_eig(data.pca, addlabels=TRUE)
#biplot of the attributes
fviz_pca_var(data.pca, col.var = "black")
#contribution of each variable
fviz_cos2(data.pca, choice = "var", axes = 1:2)
#biplot combined with cos2
fviz_pca_var(data.pca, col.var = "cos2",
             gradient.cols = c("black", "blue", "red"),
             repel = TRUE)


############
#ecospat tutorial
library(ecospat)
library(raster)
library(rgbif)
library(maptools)
library(devtools)
library(terra)
library(ade4)
library(ape)
library(biomod2)

#let's try to extract the wordclim wariables for the occurrences points
coordinates(mangroves_subset) <- c("decimalLongitude", "decimalLatitude")
proj4string(mangroves_subset) <- CRS("+proj=longlat +datum=WGS84")
occ_bioclim <- extract(mydata, mangroves_subset)
#now let's add them into one dataset
merged_data <- cbind(mangroves_subset, occ_bioclim)
merged_data

#let's see if it worked
data(wrld_simpl)
par(mar = c(1, 0, 0, 0))
plot(wrld_simpl, border = "gray80")
points(merged_data, pch=16, col=2, cex=0.3)

#let's turn it into a dataframe
merged_data.df <- as.data.frame(merged_data)
for (col in 1:ncol(merged_data.df)) {
  # Check if column name contains "temp"
  if (grepl("temp", colnames(merged_data.df)[col])) {
    # Divide column values by 10
    merged_data.df[, col] <- merged_data.df[, col] / 10
  }
}
merged_data.df <- na.omit(merged_data.df)
merged_data.df
names(merged_data.df)

#now let's calculate basic statistics
occBNE_stats <- apply(merged_data.df, 2, function(x) c(min=min(x), median(x), mean=mean(x), max=max(x), sd=sd(x)))
occBNE_stats

#now let's calculate the spatial autocorrelation
ecospat.mantel.correlogram(dfvar=merged_data.df[c(1:9)],colxy=8:9, n=100, colvar=1:7, 
                           max=10, nclass=10, nperm=100)

#core-modelling
#niche quantification
new_data_brisbane <- na.omit(new_data_brisbane)
pca.clim <- dudi.pca(new_data_brisbane, center=TRUE, scale=TRUE, scannf=FALSE, nf=2)
bne_scores <- pca.clim$li

bne_scores_LS <- suprow(pca.clim, merged_data.df[, 2:7])$li
bne_scores_Env <- suprow(pca.clim, new_data_brisbane)$li


#let's plot the niche
bne_grid <- ecospat.grid.clim.dyn(bne_scores, bne_scores_Env, bne_scores_LS)
ecospat.plot.niche.dyn(bne_grid, bne_grid, quant = 0.1, interest = 2, title = "Niche", name.axis1 = "PC1", name.axis2 = "PC2")

#let's plot the variable contributions
ecospat.plot.contrib(contrib=pca.clim$co, eigen=pca.clim$eig)
